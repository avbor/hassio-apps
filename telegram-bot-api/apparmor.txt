#include <tunables/global>

profile telegram-bot-api flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>

  # Network permissions
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,

  # S6-Overlay
  capability kill,
  capability setuid,
  capability setgid,
  capability chown,
  signal (send) set=(kill,term,int,hup,cont),

  # Base Home Assistant / S6
  /init ix,
  /bin/** ix,
  /usr/bin/** ix,
  /run/{s6,s6-rc*,service}/** ix,
  /package/** ix,
  /command/** ix,
  /etc/services.d/** rwix,
  /etc/cont-init.d/** rwix,
  /etc/cont-finish.d/** rwix,
  /run/{,**} rwk,
  /dev/tty rw,
  /etc/passwd r,
  /etc/group r,

  # Bashio and temp
  /usr/lib/bashio/** ix,
  /tmp/** rwk,

  # Persistant data
  /data/{,**} rw,

  # External folders access
  /media/{,**} rw,

  # Переход в подпрофиль для самого бинарника
  /usr/local/bin/telegram-bot-api cx -> telegram_server,

  profile telegram_server flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    #include <abstractions/openssl>

    # Init
    /init r,
    /init ix,

    # Network
    network inet stream,
    network inet6 stream,

    # S6 base
    /bin/** rmix,
    /usr/bin/** rmix,
    /usr/local/bin/** rmix,
    /etc/s6-linux-init/** r,
    /run/s6/** rwk,

    # S6 signals
    signal (receive) peer=telegram-bot-api,
    signal (receive) peer=*_telegram-bot-api,

    # Folders access
    /data/{,**} rw,
    /media/{,**} rw,

    # Binary and libs
    /usr/local/bin/telegram-bot-api r,
    /lib/** rm,
    /usr/lib/** rm,
    
    # System resources
    /etc/ssl/certs/ca-certificates.crt r,
    /etc/resolv.conf r,
    /etc/nsswitch.conf r,
    /etc/hosts r,
    /dev/urandom r,
    /dev/null rw,
  }
}