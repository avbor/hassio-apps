#include <tunables/global>

profile "{96e39688_telegram-bot-api,telegram-bot-api}" flags=(attach_disconnected,mediate_deleted) {
  #include <abstractions/base>
  #include <abstractions/nameservice>
  #include <abstractions/openssl>
  #include <abstractions/consoles>

  # S6-OVERLAY V3 CORE
  /init rmix,
  /run.sh rmix,
  /bin/sh rmix,
  /bin/bash rmix,
  /usr/bin/bash rmix,
  
  # s6
  /etc/s6-overlay/** rmix,
  /usr/lib/s6-overlay/** rmix,
  /etc/s6-linux-init/** rmix,
  /**/.s6-svscan/** rmix,

  /run/s6/** rmix,
  /run/s6-rc/** rmix,
  /run/s6-linux-init/** rmix,
  /run/s6/basedir/bin/** rmix,
  /run/s6/basedir/scripts/** rmix,
  /run/s6-rc/servicedirs/** rmix,

  # Capabilities
  capability kill,
  capability setuid,
  capability setgid,
  capability chown,
  capability dac_override,
  capability sys_chroot,
  capability sys_ptrace,

  # ptrace
  ptrace (trace, read, tracee) peer="@{profile_name}",
  ptrace (read, tracee) peer=unconfined,

  # Signals
  signal (send, receive) set=(kill,term,int,hup,cont),
  signal (receive) peer=unconfined,
  signal (receive) peer="@{profile_name}",

  # Network and System
  network inet stream,
  network inet6 stream,
  network inet dgram,
  network inet6 dgram,

  /bin/** rmix,
  /usr/bin/** rmix,
  /usr/local/bin/** rmix,
  /lib/** rm,
  /usr/lib/** rm,
  /usr/lib/bashio/** rmix,
  
  /etc/passwd r,
  /etc/group r,
  /etc/nsswitch.conf r,
  /etc/resolv.conf r,
  /etc/hosts r,
  /etc/ssl/certs/ca-certificates.crt r,
  
  /run/{,**} rwk,
  /tmp/** rwk,
  /dev/tty rw,
  /dev/null rw,
  /dev/urandom r,

  # App data
  /data/{,**} rw,
  /media/{,**} rw,

  /usr/local/bin/telegram-bot-api cx -> telegram_server,

  profile telegram_server flags=(attach_disconnected,mediate_deleted) {
    #include <abstractions/base>
    #include <abstractions/nameservice>
    #include <abstractions/openssl>

    network inet stream,
    network inet6 stream,

    signal (receive) peer="{96e39688_telegram-bot-api,telegram-bot-api}",

    /data/{,**} rw,
    /media/{,**} rw,
    /usr/local/bin/telegram-bot-api r,
    /lib/** rm,
    /usr/lib/** rm,
    
    /etc/ssl/certs/ca-certificates.crt r,
    /etc/resolv.conf r,
    /etc/hosts r,
    /dev/urandom r,
    /dev/null rw,
  }
}